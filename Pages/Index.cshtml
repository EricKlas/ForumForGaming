@page
@using Models;
@model IndexModel
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Home page";
    var user = await UserManager.GetUserAsync(User);
}
<body class="indexbody">
@if (Model.Post != null)
{
    <div class="card">
        <div class="card-header">
            <h2>@Model.Post.Title</h2>
        </div>
        <ul class="list-group list-group-flush">
            @foreach (var comment in Model.Comments)
            {
                if (comment.PostId == Model.Post.Id)
                {
                    var commentUser = await UserManager.FindByIdAsync(comment.UserId);
                    var replaytext = Model.Comments.FirstOrDefault(c => c.Id == comment.ReplyToId);

                    <li class="list-group-item">
                        @if (comment.TextContent == "Comment has been deleted by user!" || comment.TextContent == "Comment has been deleted!")
                        {
                            <img class="card-img-top profile-border" src="~/profileImages/DefaultImage.jpg" />
                            <label class="comment-username">Deleted User</label>
                            <label class="comment-date"> @comment.CreatedDate</label>
                            <br />
                            <label class="comment">@comment.TextContent</label>
                        }
                        else
                        {
                            <img class="card-img-top profile-border" src="~/profileImages/@commentUser.ProfilePicture" />
                            <label class="comment-username">@commentUser.UserName</label>
                            <label class="comment-date"> @comment.CreatedDate</label>
                            <br />
                            <label class="comment">@comment.TextContent</label>
                        }

                        @if (replaytext != null)
                        {
                            <br />
                            <span class="list-group-item gray-background">
                                <img class="card-img-top profile-border" src="~/profileImages/DefaultImage.jpg" />
                                <label> Deleted user, Datum: @replaytext.CreatedDate</label>
                                <br />
                                <label class="comment">@replaytext.TextContent</label>
                            </span>
                        }

                        @if (user != null)
                        {
                            <br />
                            <br />
                            <a asp-page="./Index" asp-route-postId="@Model.Post.Id" asp-route-replayTextId="@comment.Id" class="btn btn-primary">Reply</a>
                            <a asp-route-reportCommentId="@comment.Id" class="btn btn-primary">Report Comment</a>
                            @if (user.Id == comment.UserId)
                            {
                                <a asp-route-deleteCommentId="@comment.Id" class="btn btn-primary">Ta bort</a>
                            }
                        }
                    </li>
                }
            }
        </ul>

        @if (SignInManager.IsSignedIn(User))
        {
            <div class="CommentBox">
                <form method="post" enctype="multipart/form-data" class="form-postion">
                    <label asp-for="Comment.TextContent">Skriv din kommentar här: </label>
                    <br />
                    <textarea asp-for="Comment.TextContent" type="text" class"form-contrl limited-width-textarea" cols="70" rows="3"></textarea>
                    <br />
                    <input type="hidden" name="postId" value="@Model.Post.Id" />
                    <input type="hidden" name="replyToId" value="@Model.ReplayId" />
                    <input type="submit" name="add" class="btn btn-success" value="Post Comment"/>
                </form>
            </div>
        }
    </div>
}
else if (Model.SubCategory != null)
{
    <div class="card">
        <div class="card-header">
        <h2>@Model.SubCategory.Name</h2>
        </div>
        @if(user != null)
        {
            <form method="post" enctype="multipart/form-data" class="form-postion">
                <label asp-for="Post.Title"></label>
                <br />
                <input asp-for="Post.Title" />
                <br />
                <label asp-for="Comment.TextContent"></label>
                <textarea asp-for="Comment.TextContent" type="text" class="form-control limited-width-textarea" cols="25" rows="2"></textarea>
                <br />
                <input type="hidden" name="subCategoryId" value="@Model.SubCategory.Id" />
                <input type="submit" name="add" class="btn btn-success" value="Create Post" />
            </form>
        }
        <br />
        <table>
            <tr>
                <th>Titel</th>
                <th>Författare</th>
                <th>Skapad</th>
            </tr>

            
        @foreach (var post in Model.Posts)
        {
                if (post.SubCategoryId == Model.SubCategory.Id)
                {
                    var postUser = await UserManager.FindByIdAsync(post.UserId);
                    <tr data-href="@Url.Action("PostClicked", new { postId = post.Id })" class="clickable-row tr-link">
                        <td class="posttext">@post.Title</td>
                        <td class="author">@postUser.UserName</td>
                        <td class="created">@post.CreatedDate.ToString("yyyy-MM-dd")</td>
                    </tr>
                }
            } 
        </table>
    </div>
}
else
{
    @foreach (var category in Model.MainCategories)
    {
        if (category.Archived != true)
        {
            <div class="card">
                <div class="card-header">
                    <h2>@category.Title</h2>
                    <br />
                    <label>@category.Description</label>
                </div>
                @foreach (var subCategory in Model.SubCategories)
                {
                    if (subCategory.Archived != true)
                    {
                        if (@category.Id == subCategory.MainCategoryId)
                        {
                            <div class="card-body">  
                                <a asp-route-subCategoryId="@subCategory.Id" class="btn btn-primary"><label>@subCategory.Name</label></a>
                            </div>
                        }
                    }
                }
            </div>
        }
    }
}
</body>